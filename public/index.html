<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>The Coder</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-black text-white min-h-screen flex flex-col">

    <!-- Header -->
    <header class="w-full flex justify-between items-center p-6">
        <h1 class="text-2xl font-bold">The Coder</h1>
        <button id="adminBtn"
                class="bg-gradient-to-r from-blue-500 to-blue-700 px-4 py-2 rounded-lg shadow-lg hover:opacity-90 transition-all">
            Admin
        </button>
    </header>

    <!-- Main About Section -->
    <main id="aboutSection" class="flex-1 flex flex-col items-center justify-center">
        <h2 class="text-4xl font-bold mb-4">Who Am I?</h2>
        <p class="max-w-xl text-center text-gray-300">
            I am the coder. I make cool sites. This one has a lot of easter eggs. You might know me by schooladminwebtesting.xyz, anonychat.xyz, and multiple other sites.
            I can assure this is not a game site. Somewhere on here, you can find who I truly am.
        </p>

        <h2 class="text-4xl font-bold mb-4">Good Luck...</h2>
    </main>

    <!-- NOTE: No Applications DOM here in static HTML; will be created dynamically after login -->
    <!-- Login Overlay -->
    <div id="loginOverlay" class="hidden fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center">
        <div class="bg-gray-900 p-6 rounded-lg shadow-lg max-w-sm w-full">
            <h3 class="text-xl font-bold mb-4">Admin Access</h3>
            <input id="adminCode" type="password" placeholder="Enter Code"
                   class="w-full px-3 py-2 rounded bg-black border border-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4">
            <button id="loginBtn"
                    class="w-full bg-gradient-to-r from-blue-500 to-blue-700 py-2 rounded-lg hover:opacity-90">
                Enter
            </button>
            <p id="loginError" class="hidden text-red-500 text-sm mt-2">Invalid code.</p>
        </div>
    </div>

    <script>
        // Elements from static HTML
        const adminBtn = document.getElementById("adminBtn");
        const loginOverlay = document.getElementById("loginOverlay");
        const loginBtn = document.getElementById("loginBtn");
        const adminCodeInput = document.getElementById("adminCode");
        const loginError = document.getElementById("loginError");
        const aboutSection = document.getElementById("aboutSection");

        // runtime state
        let files = [];
        let appsContainer = null;

        adminBtn.addEventListener("click", () => {
            loginOverlay.classList.remove("hidden");
        });

        loginBtn.addEventListener("click", async () => {
            loginError.classList.add("hidden");
            const code = adminCodeInput.value;
            try {
                const res = await fetch("/api/login", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ code })
                });

                if (res.ok) {
                    loginOverlay.classList.add("hidden");
                    aboutSection.classList.add("hidden");
                    await initApplicationsUI();
                } else {
                    loginError.classList.remove("hidden");
                }
            } catch (err) {
                console.error("Login error:", err);
                loginError.classList.remove("hidden");
            } finally {
                adminCodeInput.value = "";
            }
        });

        /* Build the Applications UI dynamically and attach to the DOM */
        async function initApplicationsUI() {
            appsContainer = document.createElement("main");
            appsContainer.id = "appsSectionDynamic";
            appsContainer.className = "flex-1 flex flex-col p-8 bg-black";

            // Title
            const h = document.createElement("h2");
            h.className = "text-3xl font-bold mb-4";
            h.textContent = "Applications";
            appsContainer.appendChild(h);

            // Search input (hidden until files loaded)
            const search = document.createElement("input");
            search.id = "appsSearchDynamic";
            search.type = "text";
            search.placeholder = "Search applications...";
            search.className = "hidden mb-6 p-3 rounded-lg w-full bg-gray-800 border border-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-blue-500";
            appsContainer.appendChild(search);

            // Grid
            const grid = document.createElement("div");
            grid.id = "appsGridDynamic";
            grid.className = "grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6";
            appsContainer.appendChild(grid);

            // Viewer (NOTE: this is a DIV target for inline injection, NOT an iframe)
            const viewerWrap = document.createElement("div");
            viewerWrap.id = "appViewerDynamic";
            viewerWrap.className = "mt-6 hidden";
            const viewerInner = document.createElement("div");
            viewerInner.id = "appViewerInner";
            // Keep a consistent look: container with white bg for apps so they appear clean
            viewerInner.className = "w-full bg-white text-black rounded-xl p-0 overflow-auto";
            viewerWrap.appendChild(viewerInner);
            appsContainer.appendChild(viewerWrap);

            // Exit button
            const exitBtn = document.createElement("button");
            exitBtn.className = "mt-6 px-3 py-2 rounded bg-gray-800 text-white w-32";
            exitBtn.textContent = "Exit";
            exitBtn.addEventListener("click", () => {
                appsContainer.remove();
                aboutSection.classList.remove("hidden");
                appsContainer = null;
                files = [];
            });
            appsContainer.appendChild(exitBtn);

            // Append to body
            document.body.appendChild(appsContainer);

            // Load files and populate
            await loadFilesIntoGrid(grid, search, viewerInner, viewerWrap);
        }

        /* load /api/files and build tile list (searchable) */
        async function loadFilesIntoGrid(grid, searchEl, viewerInner, viewerWrap) {
            grid.innerHTML = '<div class="col-span-full p-6 text-gray-400">Loading applications...</div>';
            try {
                const res = await fetch("/api/files");
                if (!res.ok) throw new Error("failed to list files");
                files = await res.json();
                if (!Array.isArray(files)) files = [];
                grid.innerHTML = "";
                if (files.length === 0) {
                    grid.innerHTML = '<div class="col-span-full p-6 text-gray-400">No .html files found in repo root.</div>';
                    return;
                }
                // show search
                searchEl.classList.remove("hidden");
                files.forEach(fn => createTileForFile(fn, grid, viewerInner, viewerWrap));
                // wire search
                searchEl.addEventListener("input", () => {
                    const q = searchEl.value.trim().toLowerCase();
                    grid.innerHTML = "";
                    files
                        .filter(fn => fn.replace(/\.html?$/i, "").toLowerCase().includes(q))
                        .forEach(fn => createTileForFile(fn, grid, viewerInner, viewerWrap));
                });
            } catch (err) {
                console.error("Error loading files:", err);
                grid.innerHTML = '<div class="col-span-full p-6 text-red-500">Failed to load applications.</div>';
            }
        }

        /* create a tile that loads the file inline (no iframe) */
        function createTileForFile(filename, gridEl, viewerInner, viewerWrap) {
            const title = filename.replace(/\.html?$/i, "");
            const card = document.createElement("div");
            card.className = "bg-gray-800 p-4 rounded-lg shadow hover:shadow-lg transition";
            card.innerHTML = `
                    <h4 class="text-lg font-semibold mb-2">${escapeHtml(title)}</h4>
                    <p class="text-sm text-gray-400 mb-3">Utilize the application below</p>
                    <div class="flex justify-end">
                      <button class="utilBtn bg-gradient-to-r from-blue-500 to-blue-700 px-3 py-2 rounded shadow text-black">Utilize</button>
                    </div>
                `;
            const btn = card.querySelector(".utilBtn");
            btn.addEventListener("click", async () => {
                try {
                    // fetch app HTML from server endpoint (serves from public/UBG4ALL)
                    const r = await fetch("/api/file/" + encodeURIComponent(filename));
                    if (!r.ok) throw new Error("failed to load file");
                    const text = await r.text();
                    // inject inline while preserving relative resource resolution:
                    await loadAppInlineFromHtml(text, viewerInner);
                    viewerWrap.classList.remove("hidden");
                    viewerWrap.scrollIntoView({ behavior: "smooth", block: "start" });
                } catch (err) {
                    console.error("Failed to load app:", err);
                    alert("Failed to load application.");
                }
            });
            gridEl.appendChild(card);
        }

        /* Inject fetched HTML into mountEl and execute scripts.
           This sets a <base> so relative URLs resolve to /UBG4ALL/ on the server. */
        async function loadAppInlineFromHtml(htmlString, mountEl) {
            try {
                // compute base href relative to UBG folder on server
                const baseHref = '/UBG4ALL/';
                // parse HTML
                const parser = new DOMParser();
                const doc = parser.parseFromString(htmlString, 'text/html');

                // inject base tag
                const baseTag = doc.createElement('base');
                baseTag.setAttribute('href', baseHref);
                if (doc.head) {
                    doc.head.insertBefore(baseTag, doc.head.firstChild);
                } else {
                    const head = doc.createElement('head');
                    head.appendChild(baseTag);
                    doc.documentElement.insertBefore(head, doc.body);
                }

                // gather nodes to inject (head elements except scripts, then body children)
                const frag = document.createDocumentFragment();

                // clone head children (except scripts)
                if (doc.head) {
                    Array.from(doc.head.childNodes).forEach(node => {
                        if (node.nodeName && node.nodeName.toLowerCase() === 'script') return;
                        frag.appendChild(node.cloneNode(true));
                    });
                }

                // clone body children
                Array.from(doc.body.childNodes).forEach(node => {
                    frag.appendChild(node.cloneNode(true));
                });

                // attach to mount (wipe previous)
                mountEl.innerHTML = '';
                mountEl.appendChild(frag);

                // execute scripts in order
                const scripts = Array.from(doc.querySelectorAll('script'));
                for (const s of scripts) {
                    const newScript = document.createElement('script');
                    // copy attributes
                    for (const attr of s.attributes) newScript.setAttribute(attr.name, attr.value);
                    if (s.src) {
                        // resolve relative src against baseHref
                        let src = s.getAttribute('src');
                        if (!src.startsWith('/') && !/^https?:\/\//i.test(src)) {
                            src = baseHref + src;
                        }
                        newScript.src = src;
                        // append to head and wait for load to preserve order
                        await new Promise((resolve) => {
                            newScript.onload = () => resolve();
                            newScript.onerror = () => {
                                console.warn('Failed to load script', src);
                                resolve();
                            };
                            document.head.appendChild(newScript);
                        });
                    } else {
                        // inline script: create and append (executes)
                        newScript.textContent = s.textContent;
                        document.head.appendChild(newScript);
                    }
                }
                return true;
            } catch (err) {
                console.error('loadAppInlineFromHtml error:', err);
                return false;
            }
        }

        /* escape helper */
        function escapeHtml(s) {
            return String(s).replace(/[&<>"']/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c]));
        }
    </script>
</body>
</html>
